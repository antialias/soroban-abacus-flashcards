{
  "id": "fraction-add-sub",
  "title": "Fraction Addition & Subtraction",
  "mermaidFile": "fraction-flowchart.mmd",

  "generation": {
    "preferred": {
      "leftWhole": [0, 1, 2, 3, 4, 5],
      "leftNum": [1, 2, 3, 4, 5],
      "leftDenom": [2, 3, 4, 5, 6, 8, 10, 12],
      "rightWhole": [0, 1, 2, 3, 4],
      "rightNum": [1, 2, 3, 4, 5],
      "rightDenom": [2, 3, 4, 5, 6, 8, 10, 12]
    }
  },

  "constraints": {
    "properLeftFraction": "leftNum < leftDenom",
    "properRightFraction": "rightNum < rightDenom",
    "positiveResult": "op == '+' || (leftWhole + leftNum / leftDenom) >= (rightWhole + rightNum / rightDenom)",
    "notIdentical": "leftWhole != rightWhole || leftNum != rightNum || leftDenom != rightDenom",
    "meaningfulSubtraction": "op == '+' || (leftWhole + leftNum / leftDenom) - (rightWhole + rightNum / rightDenom) >= 0.25",
    "nonTrivialNumerators": "leftNum > 0 && rightNum > 0"
  },

  "problemInput": {
    "schema": "two-fractions-with-op",
    "fields": [
      {
        "name": "leftWhole",
        "type": "integer",
        "min": 0,
        "max": 99,
        "label": "Left whole",
        "default": 0
      },
      { "name": "leftNum", "type": "integer", "min": 0, "max": 99, "label": "Left numerator" },
      { "name": "leftDenom", "type": "integer", "min": 1, "max": 99, "label": "Left denominator" },
      { "name": "op", "type": "choice", "options": ["+", "âˆ’"], "label": "Operation" },
      {
        "name": "rightWhole",
        "type": "integer",
        "min": 0,
        "max": 99,
        "label": "Right whole",
        "default": 0
      },
      { "name": "rightNum", "type": "integer", "min": 0, "max": 99, "label": "Right numerator" },
      { "name": "rightDenom", "type": "integer", "min": 1, "max": 99, "label": "Right denominator" }
    ],
    "validation": "leftDenom > 0 && rightDenom > 0",
    "examples": [
      {
        "name": "Same denom + add (simple)",
        "description": "Denominators match, no whole numbers",
        "values": {
          "leftWhole": 0,
          "leftNum": 1,
          "leftDenom": 4,
          "op": "+",
          "rightWhole": 0,
          "rightNum": 2,
          "rightDenom": 4
        }
      },
      {
        "name": "Same denom + add (mixed)",
        "description": "Denominators match, with whole numbers",
        "values": {
          "leftWhole": 2,
          "leftNum": 1,
          "leftDenom": 5,
          "op": "+",
          "rightWhole": 1,
          "rightNum": 2,
          "rightDenom": 5
        }
      },
      {
        "name": "Same denom + sub (no borrow)",
        "description": "Denominators match, top fraction bigger",
        "values": {
          "leftWhole": 3,
          "leftNum": 3,
          "leftDenom": 4,
          "op": "âˆ’",
          "rightWhole": 1,
          "rightNum": 1,
          "rightDenom": 4
        }
      },
      {
        "name": "Same denom + sub (borrow)",
        "description": "Denominators match, need to borrow",
        "values": {
          "leftWhole": 3,
          "leftNum": 1,
          "leftDenom": 4,
          "op": "âˆ’",
          "rightWhole": 1,
          "rightNum": 3,
          "rightDenom": 4
        }
      },
      {
        "name": "One divides + add (simple)",
        "description": "4 divides 8, no whole numbers",
        "values": {
          "leftWhole": 0,
          "leftNum": 1,
          "leftDenom": 4,
          "op": "+",
          "rightWhole": 0,
          "rightNum": 3,
          "rightDenom": 8
        }
      },
      {
        "name": "One divides + add (mixed)",
        "description": "4 divides 8, with whole numbers",
        "values": {
          "leftWhole": 2,
          "leftNum": 1,
          "leftDenom": 4,
          "op": "+",
          "rightWhole": 1,
          "rightNum": 3,
          "rightDenom": 8
        }
      },
      {
        "name": "One divides + sub (borrow)",
        "description": "3 divides 6, need to borrow",
        "values": {
          "leftWhole": 3,
          "leftNum": 1,
          "leftDenom": 6,
          "op": "âˆ’",
          "rightWhole": 1,
          "rightNum": 2,
          "rightDenom": 3
        }
      },
      {
        "name": "LCD + add (simple)",
        "description": "Find LCD=12, no whole numbers",
        "values": {
          "leftWhole": 0,
          "leftNum": 1,
          "leftDenom": 3,
          "op": "+",
          "rightWhole": 0,
          "rightNum": 1,
          "rightDenom": 4
        }
      },
      {
        "name": "LCD + add (mixed)",
        "description": "Find LCD=12, with whole numbers",
        "values": {
          "leftWhole": 2,
          "leftNum": 2,
          "leftDenom": 3,
          "op": "+",
          "rightWhole": 1,
          "rightNum": 3,
          "rightDenom": 4
        }
      },
      {
        "name": "LCD + sub (borrow)",
        "description": "Find LCD=12 and borrow",
        "values": {
          "leftWhole": 4,
          "leftNum": 1,
          "leftDenom": 3,
          "op": "âˆ’",
          "rightWhole": 2,
          "rightNum": 3,
          "rightDenom": 4
        }
      }
    ]
  },

  "variables": {
    "lcd": { "init": "lcm(leftDenom, rightDenom)" },
    "sameBottom": { "init": "leftDenom == rightDenom" },
    "oneDividesOther": { "init": "leftDenom % rightDenom == 0 || rightDenom % leftDenom == 0" },
    "leftMultiplier": { "init": "lcd / leftDenom" },
    "rightMultiplier": { "init": "lcd / rightDenom" },
    "leftNewNum": { "init": "leftNum * (lcd / leftDenom)" },
    "rightNewNum": { "init": "rightNum * (lcd / rightDenom)" },
    "isSubtraction": { "init": "op == 'âˆ’'" },
    "needsBorrow": { "init": "op == 'âˆ’' && leftNewNum < rightNewNum" },

    "rawResultNum": {
      "init": "op == '+' ? (leftNewNum + rightNewNum) : (needsBorrow ? (leftNewNum + lcd - rightNewNum) : (leftNewNum - rightNewNum))"
    },
    "resultGcd": { "init": "gcd(rawResultNum, lcd)" },
    "needsSimplify": { "init": "resultGcd > 1" },
    "simplifiedNum": { "init": "rawResultNum / resultGcd" },
    "simplifiedDenom": { "init": "lcd / resultGcd" },
    "isImproper": { "init": "simplifiedNum >= simplifiedDenom" }
  },

  "workingProblem": {
    "initial": "(leftWhole > 0 ? (leftWhole + ' ') : '') + leftNum + '/' + leftDenom + ' ' + op + ' ' + (rightWhole > 0 ? (rightWhole + ' ') : '') + rightNum + '/' + rightDenom"
  },

  "entryNode": "STEP0",

  "nodes": {
    "STEP0": {
      "type": "checkpoint",
      "prompt": "What are the two bottom numbers (denominators)?",
      "inputType": "two-numbers",
      "inputLabels": ["First", "Second"],
      "expected": ["leftDenom", "rightDenom"],
      "orderMatters": false
    },
    "STEP1": {
      "type": "decision",
      "correctAnswer": "sameBottom",
      "options": [
        { "label": "YES âœ“", "value": "yes", "next": "READY1", "pathLabel": "Same", "gridLabel": "Same denominators" },
        { "label": "NO", "value": "no", "next": "STEP2", "pathLabel": "Diff", "gridLabel": "Different denominators" }
      ]
    },
    "READY1": {
      "type": "milestone",
      "next": "CHECK1"
    },
    "STEP2": {
      "type": "decision",
      "correctAnswer": "oneDividesOther",
      "options": [
        { "label": "YES", "value": "yes", "next": "CONV1A", "pathLabel": "Divides", "gridLabel": "Multiply one" },
        { "label": "NO", "value": "no", "next": "STEP3", "pathLabel": "LCD", "gridLabel": "Multiply both" }
      ]
    },
    "CONV1A": {
      "type": "checkpoint",
      "prompt": "What's the multiplier for the smaller denominator?",
      "inputType": "number",
      "expected": "max(leftDenom, rightDenom) / min(leftDenom, rightDenom)",
      "workingProblemUpdate": {
        "result": "(leftWhole > 0 ? (leftWhole + ' ') : '') + leftNewNum + '/' + lcd + ' ' + op + ' ' + (rightWhole > 0 ? (rightWhole + ' ') : '') + rightNewNum + '/' + lcd",
        "label": "Converted to common denominator"
      }
    },
    "CONV1B": {
      "type": "instruction",
      "advance": "tap"
    },
    "CONV1C": {
      "type": "instruction",
      "advance": "tap"
    },
    "READY2": {
      "type": "milestone",
      "next": "CHECK1"
    },
    "STEP3": {
      "type": "checkpoint",
      "prompt": "What's the LCD (common denominator)?",
      "inputType": "number",
      "expected": "lcd",
      "workingProblemUpdate": {
        "result": "(leftWhole > 0 ? (leftWhole + ' ') : '') + leftNewNum + '/' + lcd + ' ' + op + ' ' + (rightWhole > 0 ? (rightWhole + ' ') : '') + rightNewNum + '/' + lcd",
        "label": "Found common denominator"
      }
    },
    "STEP3B": {
      "type": "instruction",
      "advance": "tap"
    },
    "READY3": {
      "type": "milestone",
      "next": "CHECK1"
    },
    "CHECK1": {
      "type": "instruction",
      "advance": "tap"
    },
    "REMIND": {
      "type": "instruction",
      "advance": "tap"
    },
    "ADDSUB": {
      "type": "decision",
      "correctAnswer": "!isSubtraction",
      "options": [
        { "label": "âž• Adding", "value": "add", "next": "GOSTEP4", "pathLabel": "+", "gridLabel": "Add" },
        { "label": "âž– Subtracting", "value": "sub", "next": "BORROWCHECK", "pathLabel": "âˆ’", "gridLabel": "Subtract" }
      ]
    },
    "GOSTEP4": {
      "type": "milestone",
      "next": "CHECK2"
    },
    "BORROWCHECK": {
      "type": "decision",
      "correctAnswer": "!needsBorrow",
      "options": [
        {
          "label": "YES âœ“ (big enough)",
          "value": "yes",
          "next": "GOSTEP4B",
          "pathLabel": "no borrow",
          "gridLabel": "No borrowing"
        },
        { "label": "ðŸ˜± NO! (need borrow)", "value": "no", "next": "BORROW", "pathLabel": "borrow", "gridLabel": "Borrow first" }
      ]
    },
    "GOSTEP4B": {
      "type": "milestone",
      "next": "CHECK2"
    },
    "BORROW": {
      "type": "checkpoint",
      "prompt": "After borrowing, what's the new top number?",
      "inputType": "number",
      "expected": "leftNewNum + lcd",
      "workingProblemUpdate": {
        "result": "(leftWhole > 1 ? ((leftWhole - 1) + ' ') : '') + (leftNewNum + lcd) + '/' + lcd + ' ' + op + ' ' + (rightWhole > 0 ? (rightWhole + ' ') : '') + rightNewNum + '/' + lcd",
        "label": "Borrowed 1 from whole"
      }
    },
    "GOSTEP4C": {
      "type": "milestone",
      "next": "CHECK2"
    },
    "CHECK2": {
      "type": "instruction",
      "advance": "tap"
    },
    "STEP4": {
      "type": "instruction",
      "advance": "tap"
    },
    "SIMPLIFY_Q": {
      "type": "decision",
      "correctAnswer": "!needsSimplify",
      "options": [
        { "label": "NO âœ“ (can't simplify)", "value": "no", "next": "IMPROPER_Q", "pathLabel": "no simp", "gridLabel": "Already simple" },
        { "label": "YES (can simplify)", "value": "yes", "next": "SIMPLIFY_HOW", "pathLabel": "simplify", "gridLabel": "Reduce it" }
      ]
    },
    "SIMPLIFY_HOW": {
      "type": "instruction",
      "advance": "tap"
    },
    "IMPROPER_Q": {
      "type": "decision",
      "correctAnswer": "!isImproper",
      "options": [
        { "label": "NO âœ“ (proper fraction)", "value": "no", "next": "CHECK3", "pathLabel": "proper", "gridLabel": "Proper result" },
        { "label": "YES (improper)", "value": "yes", "next": "MIXED_HOW", "pathLabel": "â†’mixed", "gridLabel": "Make mixed" }
      ]
    },
    "MIXED_HOW": {
      "type": "instruction",
      "advance": "tap"
    },
    "CHECK3": {
      "type": "instruction",
      "advance": "tap"
    },
    "DONE": {
      "type": "terminal",
      "celebration": true
    }
  },

  "edges": {
    "STEP0": ["STEP1"],
    "CONV1A": ["CONV1B"],
    "CONV1B": ["CONV1C"],
    "CONV1C": ["READY2"],
    "STEP3": ["STEP3B"],
    "STEP3B": ["READY3"],
    "CHECK1": ["REMIND"],
    "REMIND": ["ADDSUB"],
    "BORROW": ["GOSTEP4C"],
    "CHECK2": ["STEP4"],
    "STEP4": ["SIMPLIFY_Q"],
    "SIMPLIFY_HOW": ["IMPROPER_Q"],
    "MIXED_HOW": ["CHECK3"],
    "CHECK3": ["DONE"]
  }
}
