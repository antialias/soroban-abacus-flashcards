'use client'

import { useTranslations } from 'next-intl'
import { css } from '../../../../../../styled-system/css'
import { stack } from '../../../../../../styled-system/patterns'
import type { WorksheetFormState } from '../types'
import { DisplayOptionsPreview } from './DisplayOptionsPreview'
import { ModeSelector } from './ModeSelector'
import { defaultAdditionConfig } from '../../config-schemas'
import { SubOption } from './config-panel/SubOption'
import { ToggleOption } from './config-panel/ToggleOption'
import { StudentNameInput } from './config-panel/StudentNameInput'
import { DigitRangeSection } from './config-panel/DigitRangeSection'
import { OperatorSection } from './config-panel/OperatorSection'
import { ProgressiveDifficultyToggle } from './config-panel/ProgressiveDifficultyToggle'
import { SmartModeControls } from './config-panel/SmartModeControls'

interface ConfigPanelProps {
  formState: WorksheetFormState
  onChange: (updates: Partial<WorksheetFormState>) => void
}

export function ConfigPanel({ formState, onChange }: ConfigPanelProps) {
  const t = useTranslations('create.worksheets.addition')
  const [showDebugPlot, setShowDebugPlot] = useState(false)
  const [hoverPoint, setHoverPoint] = useState<{ x: number; y: number } | null>(null)
  const [hoverPreview, setHoverPreview] = useState<{
    pAnyStart: number
    pAllStart: number
    displayRules: DisplayRules
    matchedProfile: string | 'custom'
  } | null>(null)

  // Helper to get default column count for a given problemsPerPage (user can override)
  const getDefaultColsForProblemsPerPage = (
    problemsPerPage: number,
    orientation: 'portrait' | 'landscape'
  ): number => {
    if (orientation === 'portrait') {
      // Portrait: prefer 2-3 columns
      if (problemsPerPage === 6) return 2
      if (problemsPerPage === 8) return 2
      if (problemsPerPage === 10) return 2
      if (problemsPerPage === 12) return 3
      if (problemsPerPage === 15) return 3
      return 2 // default
    } else {
      // Landscape: prefer 4-5 columns
      if (problemsPerPage === 8) return 4
      if (problemsPerPage === 10) return 5
      if (problemsPerPage === 12) return 4
      if (problemsPerPage === 15) return 5
      if (problemsPerPage === 16) return 4
      if (problemsPerPage === 20) return 5
      return 4 // default
    }
  }

  // Helper to calculate derived state (rows, total) from primary state (problemsPerPage, cols, pages)
  const calculateDerivedState = (problemsPerPage: number, cols: number, pages: number) => {
    const rowsPerPage = problemsPerPage / cols
    const rows = rowsPerPage * pages
    const total = problemsPerPage * pages
    return { rows, total }
  }

  // Get current primary state with defaults
  const currentOrientation = formState.orientation || 'portrait'
  const currentProblemsPerPage =
    formState.problemsPerPage || (currentOrientation === 'portrait' ? 15 : 20)
  const currentCols =
    formState.cols || getDefaultColsForProblemsPerPage(currentProblemsPerPage, currentOrientation)
  const currentPages = formState.pages || 1

  console.log('=== ConfigPanel Render ===')
  console.log('Primary state:', {
    problemsPerPage: currentProblemsPerPage,
    cols: currentCols,
    pages: currentPages,
    orientation: currentOrientation,
  })
  console.log(
    'Derived state:',
    calculateDerivedState(currentProblemsPerPage, currentCols, currentPages)
  )

  // Helper function to handle difficulty adjustments
  const handleDifficultyChange = (mode: DifficultyMode, direction: 'harder' | 'easier') => {
    // Defensive: Ensure all required fields are defined before calling makeHarder/makeEasier
    // This prevents "Cannot read properties of undefined" errors in production

    // Log warning if any fields are missing (helps debug production issues)
    if (!formState.displayRules || !formState.pAnyStart || !formState.pAllStart) {
      console.error('[ConfigPanel] Missing required fields for difficulty adjustment!', {
        hasDisplayRules: !!formState.displayRules,
        hasPAnyStart: formState.pAnyStart !== undefined,
        hasPAllStart: formState.pAllStart !== undefined,
        formState,
      })
    }

    const currentState = {
      pAnyStart: formState.pAnyStart ?? defaultAdditionConfig.pAnyStart,
      pAllStart: formState.pAllStart ?? defaultAdditionConfig.pAllStart,
      displayRules: formState.displayRules ?? defaultAdditionConfig.displayRules,
    }

    const result =
      direction === 'harder' ? makeHarder(currentState, mode) : makeEasier(currentState, mode)

    const beforeReg = calculateRegroupingIntensity(currentState.pAnyStart, currentState.pAllStart)
    const beforeScaf = calculateScaffoldingLevel(currentState.displayRules, beforeReg)
    const afterReg = calculateRegroupingIntensity(result.pAnyStart, result.pAllStart)
    const afterScaf = calculateScaffoldingLevel(result.displayRules, afterReg)

    console.log(`=== MAKE ${direction.toUpperCase()} (${mode}) ===`)
    console.log(
      `BEFORE: (${beforeReg.toFixed(2)}, ${beforeScaf.toFixed(2)}) | pAny=${(currentState.pAnyStart * 100).toFixed(0)}% pAll=${(currentState.pAllStart * 100).toFixed(0)}% | rules=${JSON.stringify(currentState.displayRules)}`
    )
    console.log(
      `AFTER:  (${afterReg.toFixed(2)}, ${afterScaf.toFixed(2)}) | pAny=${(result.pAnyStart * 100).toFixed(0)}% pAll=${(result.pAllStart * 100).toFixed(0)}% | rules=${JSON.stringify(result.displayRules)}`
    )
    console.log(
      `DELTA:  (${(afterReg - beforeReg).toFixed(2)}, ${(afterScaf - beforeScaf).toFixed(2)})`
    )
    console.log(`DESC:   ${result.changeDescription}`)
    console.log('==================')

    onChange({
      difficultyProfile: result.difficultyProfile,
      displayRules: result.displayRules,
      pAllStart: result.pAllStart,
      pAnyStart: result.pAnyStart,
    })
  }

  // Handler for mode switching
  const handleModeChange = (newMode: 'smart' | 'manual') => {
    if (formState.mode === newMode) {
      return // No change needed
    }

    if (newMode === 'smart') {
      // Switching to Smart mode
      // Use current displayRules if available, otherwise default to earlyLearner
      const displayRules = formState.displayRules ?? defaultAdditionConfig.displayRules
      onChange({
        mode: 'smart',
        displayRules,
        difficultyProfile: 'earlyLearner',
      } as unknown as Partial<WorksheetFormState>)
    } else {
      // Switching to Manual mode
      // Convert current displayRules to boolean flags if available
      let booleanFlags = {
        showCarryBoxes: true,
        showAnswerBoxes: true,
        showPlaceValueColors: true,
        showTenFrames: false,
        showProblemNumbers: true,
        showCellBorder: true,
        showTenFramesForAll: false,
      }

      if (formState.displayRules) {
        // Convert 'always' to true, everything else to false
        booleanFlags = {
          showCarryBoxes: formState.displayRules.carryBoxes === 'always',
          showAnswerBoxes: formState.displayRules.answerBoxes === 'always',
          showPlaceValueColors: formState.displayRules.placeValueColors === 'always',
          showTenFrames: formState.displayRules.tenFrames === 'always',
          showProblemNumbers: formState.displayRules.problemNumbers === 'always',
          showCellBorder: formState.displayRules.cellBorders === 'always',
          showTenFramesForAll: false,
        }
      }

      onChange({
        mode: 'manual',
        ...booleanFlags,
      } as unknown as Partial<WorksheetFormState>)
    }
  }

  return (
    <div data-component="config-panel" className={stack({ gap: '3' })}>
      {/* Student Name */}
      <StudentNameInput value={formState.name} onChange={(name) => onChange({ name })} />

      {/* Digit Range Selector */}
      <DigitRangeSection
        digitRange={formState.digitRange}
        onChange={(digitRange) => onChange({ digitRange })}
      />

      {/* Operator Selector */}
      <OperatorSection
        operator={formState.operator}
        onChange={(operator) => onChange({ operator })}
      />

      {/* Mode Selector */}
      <ModeSelector currentMode={formState.mode ?? 'smart'} onChange={handleModeChange} />

      {/* Progressive Difficulty Toggle - Available for both modes */}
      <ProgressiveDifficultyToggle
        interpolate={formState.interpolate}
        onChange={(interpolate) => onChange({ interpolate })}
      />


      {/* Smart Mode Controls */}
      {(!formState.mode || formState.mode === 'smart') && (
        <SmartModeControls formState={formState} onChange={onChange} />
      )}

      {/* Display Options Card - Manual Mode Only */}
      {formState.mode === 'manual' && (
        <>
          <div
            data-section="display"
            className={css({
              bg: 'gray.50',
              border: '1px solid',
              borderColor: 'gray.200',
              rounded: 'xl',
              p: '3',
            })}
          >
            <div className={stack({ gap: '3' })}>
              <div
                className={css({
                  display: 'flex',
                  justifyContent: 'space-between',
                  alignItems: 'center',
                })}
              >
                <div
                  className={css({
                    fontSize: 'xs',
                    fontWeight: 'semibold',
                    color: 'gray.500',
                    textTransform: 'uppercase',
                    letterSpacing: 'wider',
                  })}
                >
                  Display Options
                </div>
                <div className={css({ display: 'flex', gap: '1.5' })}>
                  <button
                    onClick={() =>
                      onChange({
                        showCarryBoxes: true,
                        showAnswerBoxes: true,
                        showPlaceValueColors: true,
                        showProblemNumbers: true,
                        showCellBorder: true,
                        showTenFrames: true,
                      })
                    }
                    className={css({
                      px: '2',
                      py: '0.5',
                      fontSize: '2xs',
                      color: 'brand.600',
                      border: '1px solid',
                      borderColor: 'brand.300',
                      bg: 'white',
                      rounded: 'md',
                      cursor: 'pointer',
                      _hover: { bg: 'brand.50' },
                    })}
                  >
                    Check All
                  </button>
                  <button
                    onClick={() =>
                      onChange({
                        showCarryBoxes: false,
                        showAnswerBoxes: false,
                        showPlaceValueColors: false,
                        showProblemNumbers: false,
                        showCellBorder: false,
                        showTenFrames: false,
                      })
                    }
                    className={css({
                      px: '2',
                      py: '0.5',
                      fontSize: '2xs',
                      color: 'gray.600',
                      border: '1px solid',
                      borderColor: 'gray.300',
                      bg: 'white',
                      rounded: 'md',
                      cursor: 'pointer',
                      _hover: { bg: 'gray.50' },
                    })}
                  >
                    Uncheck All
                  </button>
                </div>
              </div>

              {/* Two-column grid: toggle options on left, preview on right */}
              <div
                className={css({
                  display: 'grid',
                  gridTemplateColumns: '2fr 1fr',
                  gap: '3',
                })}
              >
                {/* Toggle Options in 2-column grid */}
                <div
                  className={css({
                    display: 'grid',
                    gridTemplateColumns: '1fr 1fr',
                    gap: '2',
                    alignItems: 'start',
                  })}
                >
                  <ToggleOption
                    checked={formState.showAnswerBoxes ?? true}
                    onChange={(checked) => onChange({ showAnswerBoxes: checked })}
                    label="Answer Boxes"
                    description="Guide students to write organized, aligned answers"
                  />

                  <ToggleOption
                    checked={formState.showPlaceValueColors ?? true}
                    onChange={(checked) => onChange({ showPlaceValueColors: checked })}
                    label="Place Value Colors"
                    description="Reinforce place value understanding visually"
                  />

                  <ToggleOption
                    checked={formState.showProblemNumbers ?? true}
                    onChange={(checked) => onChange({ showProblemNumbers: checked })}
                    label="Problem Numbers"
                    description="Help students track progress and reference problems"
                  />

                  <ToggleOption
                    checked={formState.showCellBorder ?? true}
                    onChange={(checked) => onChange({ showCellBorder: checked })}
                    label="Cell Borders"
                    description="Organize problems visually for easier focus"
                  />

                  <ToggleOption
                    checked={formState.showCarryBoxes ?? true}
                    onChange={(checked) => {
                      onChange({ showCarryBoxes: checked })
                    }}
                    label={
                      formState.operator === 'subtraction'
                        ? 'Borrow Boxes'
                        : formState.operator === 'mixed'
                          ? 'Carry/Borrow Boxes'
                          : 'Carry Boxes'
                    }
                    description={
                      formState.operator === 'subtraction'
                        ? 'Help students track borrowing during subtraction'
                        : formState.operator === 'mixed'
                          ? 'Help students track regrouping (carrying in addition, borrowing in subtraction)'
                          : 'Help students track regrouping during addition'
                    }
                  />

                  {(formState.operator === 'subtraction' || formState.operator === 'mixed') && (
                    <ToggleOption
                      checked={formState.showBorrowNotation ?? true}
                      onChange={(checked) => onChange({ showBorrowNotation: checked })}
                      label="Borrowed 10s Box"
                      description="Box for adding 10 to borrowing digit"
                    />
                  )}

                  {(formState.operator === 'subtraction' || formState.operator === 'mixed') && (
                    <ToggleOption
                      checked={formState.showBorrowingHints ?? false}
                      onChange={(checked) => onChange({ showBorrowingHints: checked })}
                      label="Borrowing Hints"
                      description="Show arrows and calculations guiding the borrowing process"
                    />
                  )}

                  <ToggleOption
                    checked={formState.showTenFrames ?? false}
                    onChange={(checked) => {
                      onChange({ showTenFrames: checked })
                    }}
                    label="Ten-Frames"
                    description="Visualize regrouping with concrete counting tools"
                  >
                    <SubOption
                      checked={formState.showTenFramesForAll ?? false}
                      onChange={(checked) => onChange({ showTenFramesForAll: checked })}
                      label="Show for all problems (not just regrouping)"
                      parentEnabled={formState.showTenFrames ?? false}
                    />
                  </ToggleOption>
                </div>

                {/* Live Preview */}
                <DisplayOptionsPreview formState={formState} />
              </div>
            </div>
          </div>

          {/* Regrouping Frequency Card - Manual Mode Only */}
          <div
            data-section="regrouping"
            className={css({
              bg: 'gray.50',
              border: '1px solid',
              borderColor: 'gray.200',
              rounded: 'xl',
              p: '3',
              mt: '3',
            })}
          >
            <div className={stack({ gap: '2.5' })}>
              <div
                className={css({
                  fontSize: 'xs',
                  fontWeight: 'semibold',
                  color: 'gray.500',
                  textTransform: 'uppercase',
                  letterSpacing: 'wider',
                })}
              >
                Regrouping Frequency
              </div>

              {/* Current values display */}
              <div
                className={css({
                  display: 'flex',
                  justifyContent: 'space-between',
                  fontSize: 'xs',
                  color: 'gray.600',
                })}
              >
                <div>
                  Both:{' '}
                  <span className={css({ color: 'brand.600', fontWeight: 'semibold' })}>
                    {Math.round((formState.pAllStart || 0) * 100)}%
                  </span>
                </div>
                <div>
                  Any:{' '}
                  <span className={css({ color: 'brand.600', fontWeight: 'semibold' })}>
                    {Math.round((formState.pAnyStart || 0.25) * 100)}%
                  </span>
                </div>
              </div>

              {/* Double-thumbed range slider */}
              <Slider.Root
                className={css({
                  position: 'relative',
                  display: 'flex',
                  alignItems: 'center',
                  userSelect: 'none',
                  touchAction: 'none',
                  width: 'full',
                  height: '6',
                })}
                value={[(formState.pAllStart || 0) * 100, (formState.pAnyStart || 0.25) * 100]}
                onValueChange={(values) => {
                  onChange({
                    pAllStart: values[0] / 100,
                    pAnyStart: values[1] / 100,
                  })
                }}
                min={0}
                max={100}
                step={5}
                minStepsBetweenThumbs={0}
              >
                <Slider.Track
                  className={css({
                    position: 'relative',
                    flexGrow: 1,
                    bg: 'gray.200',
                    rounded: 'full',
                    height: '1.5',
                  })}
                >
                  <Slider.Range
                    className={css({
                      position: 'absolute',
                      bg: 'brand.500',
                      rounded: 'full',
                      height: 'full',
                    })}
                  />
                </Slider.Track>
                <Slider.Thumb
                  className={css({
                    display: 'block',
                    width: '3.5',
                    height: '3.5',
                    bg: 'white',
                    boxShadow: '0 2px 4px rgba(0,0,0,0.15)',
                    rounded: 'full',
                    border: '2px solid',
                    borderColor: 'brand.500',
                    cursor: 'pointer',
                    _hover: { transform: 'scale(1.1)' },
                    _focus: { outline: 'none', boxShadow: '0 0 0 3px rgba(59, 130, 246, 0.3)' },
                  })}
                />
                <Slider.Thumb
                  className={css({
                    display: 'block',
                    width: '3.5',
                    height: '3.5',
                    bg: 'white',
                    boxShadow: '0 2px 4px rgba(0,0,0,0.15)',
                    rounded: 'full',
                    border: '2px solid',
                    borderColor: 'brand.600',
                    cursor: 'pointer',
                    _hover: { transform: 'scale(1.1)' },
                    _focus: { outline: 'none', boxShadow: '0 0 0 3px rgba(59, 130, 246, 0.3)' },
                  })}
                />
              </Slider.Root>

              <div className={css({ fontSize: '2xs', color: 'gray.500', lineHeight: '1.3' })}>
                Regrouping difficulty at worksheet start (Both = all columns regroup, Any = at least
                one column regroups)
              </div>
            </div>
          </div>
        </>
      )}
    </div>
  )
}
